<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abortion after the third trimester is immoral - Graph View</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Inline critical styles (graph.css will be external for customization) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
            overflow: hidden;
        }

        #header {
            background: white;
            border-bottom: 1px solid #a2a9b1;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 70px;
        }

        #header h1 {
            font-size: 1.3em;
            font-weight: 400;
            color: #202122;
            margin-bottom: 5px;
        }

        #header .meta {
            font-size: 0.85em;
            color: #72777d;
        }

        #controls {
            position: fixed;
            top: 80px;
            left: 10px;
            background: white;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            padding: 15px;
            z-index: 100;
            max-width: 250px;
        }

        #controls h3 {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #202122;
        }

        #controls input[type="text"] {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #a2a9b1;
            border-radius: 3px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        #controls button {
            width: 100%;
            padding: 6px 10px;
            margin-bottom: 5px;
            border: 1px solid #a2a9b1;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
        }

        #controls button:hover {
            background: #eaecf0;
        }

        #legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eaecf0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 5px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #eaecf0;
            border-left-width: 3px;
            border-left-color: #0645ad;
        }

        .stat-label {
            display: block;
            font-size: 0.7em;
            color: #72777d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .stat-number {
            display: block;
            font-size: 1.3em;
            font-weight: 600;
            color: #202122;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85em;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        #sidebar {
            position: fixed;
            top: 70px;
            right: -550px;
            width: 520px;
            height: calc(100vh - 70px);
            background: white;
            border-left: 2px solid #a2a9b1;
            transition: right 0.3s ease;
            z-index: 100;
            overflow-y: auto;
            padding: 0;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
        }

        #sidebar.open {
            right: 0;
        }

        #sidebar .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            font-size: 1.3em;
            cursor: pointer;
            color: #72777d;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        #sidebar .close-btn:hover {
            background: #eaecf0;
            color: #202122;
        }

        #sidebar-header {
            background: #f8f9fa;
            border-bottom: 1px solid #eaecf0;
            padding: 20px 25px;
            padding-right: 55px;
        }

        #sidebar-header h2 {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #202122;
        }

        .breadcrumb {
            font-size: 0.8em;
            color: #72777d;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: #0645ad;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a2a9b1;
            margin: 0 3px;
        }

        #sidebar-body {
            padding: 20px 25px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #72777d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .node-text {
            font-size: 0.95em;
            line-height: 1.7;
            color: #202122;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #0645ad;
        }

        .node-badge-large {
            display: inline-block;
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 8px;
        }

        .node-badge-large.pro {
            background: #d5f0e8;
            color: #2d9e7e;
            border: 1px solid #2d9e7e;
        }

        .node-badge-large.con {
            background: #f7e0e0;
            color: #c74848;
            border: 1px solid #c74848;
        }

        .node-badge-large.objection {
            background: #ffecd9;
            color: #d97a30;
            border: 1px solid #d97a30;
        }

        .node-badge-large.response {
            background: #e3eef8;
            color: #4a7fb8;
            border: 1px solid #4a7fb8;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }

        .meta-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eaecf0;
        }

        .meta-label {
            font-size: 0.75em;
            color: #72777d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 1em;
            font-weight: 600;
            color: #202122;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #a2a9b1;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: #f8f9fa;
            border-color: #0645ad;
            color: #0645ad;
        }

        .action-btn.primary {
            background: #0645ad;
            color: white;
            border-color: #0645ad;
        }

        .action-btn.primary:hover {
            background: #0051a0;
        }

        .child-node {
            background: white;
            border: 1px solid #eaecf0;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .child-node:hover {
            border-color: #0645ad;
            border-left-color: #0645ad;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .child-node.pro {
            border-left-color: #2d9e7e;
        }

        .child-node.con {
            border-left-color: #c74848;
        }

        .child-node.objection {
            border-left-color: #d97a30;
        }

        .child-node.response {
            border-left-color: #4a7fb8;
        }

        .child-node-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .child-node-badge {
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .child-node-text {
            font-size: 0.9em;
            line-height: 1.5;
            color: #202122;
        }

        .references-list {
            list-style: none;
            padding: 0;
        }

        .references-list li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .references-list li:before {
            content: "üîó";
            position: absolute;
            left: 0;
        }

        .references-list a {
            color: #0645ad;
            text-decoration: none;
            font-size: 0.85em;
            word-break: break-all;
        }

        .references-list a:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #72777d;
            font-size: 0.9em;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-box-value {
            font-size: 1.4em;
            font-weight: 600;
            color: #0645ad;
        }

        .stat-box-label {
            font-size: 0.75em;
            color: #72777d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        #graph-container {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .node {
            cursor: pointer;
        }

        .node circle {
            stroke: none;
            fill: transparent;
            opacity: 0;
            /* Keep circles for physics/collision detection but hide them */
        }

        /* Highlighted and selected states now apply to text boxes */
        .node.highlighted .node-text-content {
            outline: 3px solid #ffd700;
            outline-offset: 2px;
        }

        .node.selected .node-text-content {
            outline: 3px solid #0645ad;
            outline-offset: 2px;
        }

        /* foreignObject for text wrapping */
        .node foreignObject {
            overflow: visible;
            pointer-events: auto;  /* Make text boxes clickable */
        }

        .node-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            pointer-events: auto;  /* Make labels clickable */
        }

        .node-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 3px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .node-badge.pro {
            color: #2d9e7e;
            border-color: #2d9e7e;
        }

        .node-badge.con {
            color: #c74848;
            border-color: #c74848;
        }

        .node-badge.objection {
            color: #d97a30;
            border-color: #d97a30;
        }

        .node-badge.response {
            color: #4a7fb8;
            border-color: #4a7fb8;
        }

        .node-text-content {
            color: #202122;
            line-height: 1.4;
            word-wrap: break-word;
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-left-width: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Color-coded left borders by node type */
        .node.pro .node-text-content {
            border-left-color: #2d9e7e;
            background: rgba(213, 240, 232, 0.85);
        }

        .node.con .node-text-content {
            border-left-color: #c74848;
            background: rgba(247, 224, 224, 0.85);
        }

        .node.objection .node-text-content {
            border-left-color: #d97a30;
            background: rgba(255, 236, 217, 0.85);
        }

        .node.response .node-text-content {
            border-left-color: #4a7fb8;
            background: rgba(227, 238, 248, 0.85);
        }

        /* Depth-based opacity for hierarchy */
        .node.depth-0 .node-text-content {
            opacity: 1;
        }

        .node.depth-1 .node-text-content {
            opacity: 0.95;
        }

        .node.depth-2 .node-text-content {
            opacity: 0.9;
        }

        .node.depth-3 .node-text-content {
            opacity: 0.85;
        }

        .node.depth-4 .node-text-content {
            opacity: 0.8;
        }

        .node.depth-5 .node-text-content {
            opacity: 0.75;
        }

        /* Meta node text gets special styling */
        .node.meta-pro .node-text-content,
        .node.meta-con .node-text-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-left-width: 5px;
        }

        .node.meta-pro .node-text-content {
            background: rgba(213, 240, 232, 0.95);
            border-left-color: #2d9e7e;
        }

        .node.meta-con .node-text-content {
            background: rgba(247, 224, 224, 0.95);
            border-left-color: #c74848;
        }

        /* Subtle hover effects */
        .node:hover .node-text-content {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .link:hover {
            stroke-opacity: 0.8 !important;
            stroke-width: 3px;
        }

        .node title {
            font-size: 14px;
        }

        .link {
            stroke: #8b95a5;
            stroke-opacity: 0.3;
            fill: none;
            transition: all 0.2s ease;
        }

        /* Unified link styling - all types use same neutral color for cleaner look */
        .link.pro,
        .link.con,
        .link.objection,
        .link.response {
            stroke: #8b95a5;
            stroke-opacity: 0.3;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Abortion after the third trimester is immoral</h1>
        <div class="meta">
            4 arguments for ‚Ä¢ 4 arguments against ‚Ä¢
            32 total nodes ‚Ä¢ Max depth: 3 ‚Ä¢
            Version 4
        </div>
    </div>

    <div id="controls">
        <a href="../debates/abortion-after-the-third-trimester-is-immoral.html" style="display: block; width: 100%; padding: 8px 10px; margin-bottom: 10px; text-align: center; background: #0645ad; color: white; border-radius: 3px; text-decoration: none; font-size: 0.85em; font-weight: 500;">üìñ View Debate Page</a>

        <h3>üîç Search & Navigate</h3>
        <input type="text" id="search" placeholder="Search arguments...">
        <button onclick="resetAndFit()">üéØ Reset & Fit View</button>

        <div id="legend">
            <h3>üìä Tree Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Total Nodes</span>
                    <span class="stat-number">32</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Max Depth</span>
                    <span class="stat-number">3</span>
                </div>
                <div class="stat-item" style="border-left: 3px solid #2d9e7e;">
                    <span class="stat-label">Supporting</span>
                    <span class="stat-number" style="color: #2d9e7e;">4</span>
                </div>
                <div class="stat-item" style="border-left: 3px solid #c74848;">
                    <span class="stat-label">Opposing</span>
                    <span class="stat-number" style="color: #c74848;">4</span>
                </div>
            </div>

            <h3 style="margin-top: 15px;">üé® Argument Types</h3>
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(213, 240, 232, 0.85); border: 2px solid #2d9e7e;"></div>
                <span>Pro / Supporting</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(247, 224, 224, 0.85); border: 2px solid #c74848;"></div>
                <span>Con / Opposing</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(255, 236, 217, 0.85); border: 2px solid #d97a30;"></div>
                <span>Objection</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(227, 238, 248, 0.85); border: 2px solid #4a7fb8;"></div>
                <span>Response</span>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <button class="close-btn" onclick="closeSidebar()">√ó</button>
        <div id="sidebar-header"></div>
        <div id="sidebar-body"></div>
    </div>

    <div id="graph-container">
        <svg id="graph"></svg>
    </div>

    <script>
        // Graph data from Python
        const graphData = {
  "nodes": [
    {
      "id": "5eb0e98d-efc2-4c9a-892d-adb56324687e",
      "text": "A fetus in the third trimester is typically medically viable outside the womb; in modern neonatal intensive care units (like those prominent in the US and Europe), infants born at this stage are treated as patients with a full right to life.",
      "type": "pro",
      "side": "pro",
      "depth": 0,
      "parent_id": "meta-pro",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:09:46.306766"
    },
    {
      "id": "d95056fc-6361-4d34-b861-1996dbaa26fe",
      "text": "Neurological development by the third trimester strongly suggests the capacity for sentience and pain perception, meaning abortion procedures constitute the infliction of suffering upon a conscious being.",
      "type": "pro",
      "side": "pro",
      "depth": 0,
      "parent_id": "meta-pro",
      "children_count": 3,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:09:46.307605"
    },
    {
      "id": "7e077846-360f-4289-8598-d5758b186122",
      "text": "International ethical and legal frameworks, such as those in Western Europe (e.g., Germany, Italy), reflect a strong societal consensus that the moral weight of ending a life near viability overrides elective third-trimester termination.",
      "type": "pro",
      "side": "pro",
      "depth": 0,
      "parent_id": "meta-pro",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:09:46.308175"
    },
    {
      "id": "3914c501-10a2-44a6-a6c9-355c64c5292c",
      "text": "Biologically, a third-trimester fetus is functionally identical to a premature newborn, rendering the decision to terminate based solely on location (in or out of the womb) an arbitrary moral distinction, approximating infanticide.",
      "type": "pro",
      "side": "pro",
      "depth": 0,
      "parent_id": "meta-pro",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:09:46.308614"
    },
    {
      "id": "07a31aa8-9646-4619-b05f-e5431380044b",
      "text": "Legal frameworks are often shaped by political compromise, powerful minority interests, or historical religious influence (e.g., Italy's strong Catholic tradition), meaning they do not necessarily reflect a strong, current societal consensus.",
      "type": "objection",
      "side": "con",
      "depth": 1,
      "parent_id": "7e077846-360f-4289-8598-d5758b186122",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:09:56.276688"
    },
    {
      "id": "8138b849-bdb6-4480-98eb-1104a7805da6",
      "text": "Limiting the evidence to Germany and Italy fails to represent \"International ethical and legal frameworks,\" as many Western jurisdictions (e.g., Netherlands, UK, Canada) permit late-term abortions under broader exceptions or flexible viability standards.",
      "type": "objection",
      "side": "con",
      "depth": 1,
      "parent_id": "7e077846-360f-4289-8598-d5758b186122",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:09:56.277823"
    },
    {
      "id": "7055f356-490f-4111-9ec7-9a5d86ff7fe9",
      "text": "Functional identity is absent because the fetus relies solely on the placenta for all gas exchange, a mechanism fundamentally distinct from the independent, externally-supported respiratory and circulatory systems of a premature newborn.",
      "type": "objection",
      "side": "con",
      "depth": 1,
      "parent_id": "3914c501-10a2-44a6-a6c9-355c64c5292c",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:09:56.842378"
    },
    {
      "id": "70a2aef6-6785-4f7f-8086-e8ff380e3f15",
      "text": "The \u201clocation\u201d distinction is not arbitrary; it represents the difference between a fetus requiring the mandatory use of the mother's life-sustaining organs, which invokes the right to bodily autonomy, and a physically separated infant requiring only external medical assistance that does not infringe upon the mother's bodily sovereignty.",
      "type": "objection",
      "side": "con",
      "depth": 1,
      "parent_id": "3914c501-10a2-44a6-a6c9-355c64c5292c",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:09:56.843127"
    },
    {
      "id": "fc74bbd9-5df5-4a44-ad16-2224937436df",
      "text": "Standard third-trimester abortion protocols require feticide or deep fetal anesthesia before the procedure, universally ensuring the fetus cannot experience pain or suffering.",
      "type": "objection",
      "side": "con",
      "depth": 1,
      "parent_id": "d95056fc-6361-4d34-b861-1996dbaa26fe",
      "children_count": 1,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:03.739688"
    },
    {
      "id": "e93ba42c-c110-408f-9754-7c66765c6137",
      "text": "Integrated conscious pain perception requires high-level cortical functioning and functional thalamocortical connections, which scientific studies suggest are not sufficiently robust until after 29-30 weeks gestation.",
      "type": "objection",
      "side": "con",
      "depth": 1,
      "parent_id": "d95056fc-6361-4d34-b861-1996dbaa26fe",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:03.740729"
    },
    {
      "id": "dd4dff60-aef3-4ffe-b078-93a8a4650492",
      "text": "The fetal state is characterized by continuous endogenous sedation, hypoxia, and neuroinhibitory steroids from the placenta, meaning that even if pain pathways are established, the fetus is typically maintained in a state of unconsciousness similar to a deep coma.",
      "type": "objection",
      "side": "con",
      "depth": 1,
      "parent_id": "d95056fc-6361-4d34-b861-1996dbaa26fe",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:03.741297"
    },
    {
      "id": "45be1a59-180d-4a0a-9545-682c91b60ee4",
      "text": "Feticide is not universally required; some jurisdictions legally permit late-term Dilation and Evacuation (D&E) procedures without first administering guaranteed fetal anesthesia, meaning suffering is not systematically prevented.",
      "type": "response",
      "side": "pro",
      "depth": 2,
      "parent_id": "fc74bbd9-5df5-4a44-ad16-2224937436df",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:14.657020"
    },
    {
      "id": "41d5019d-b3a3-4c55-a627-41f9d58b89d5",
      "text": "Fetal pain response, including stress hormone release and observable withdrawal behaviors, is well-documented from 20 weeks gestation, indicating a functional nociception system that operates independently of complete adult-level cortical integration.",
      "type": "response",
      "side": "pro",
      "depth": 2,
      "parent_id": "e93ba42c-c110-408f-9754-7c66765c6137",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:16.620113"
    },
    {
      "id": "b238740e-d331-4e5b-b04b-cd0636c9bdfe",
      "text": "The thalamocortical pathways required for transmitting tactile and nociceptive information are anatomically present and established by 20 to 24 weeks gestation, suggesting the capacity for cortical processing of pain may occur earlier than the 29-30 week cutoff.",
      "type": "response",
      "side": "pro",
      "depth": 2,
      "parent_id": "e93ba42c-c110-408f-9754-7c66765c6137",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:16.620568"
    },
    {
      "id": "5b781c00-07c4-4047-ba3a-d67479a83482",
      "text": "Late-term abortions are almost exclusively performed when continuing the pregnancy poses a mortal threat to the woman, such as severe preeclampsia or aggressive cancer requiring immediate treatment. Prioritizing the life and health of a fully autonomous person over the potential life of a fetus is ethically defensible and not an immoral necessity.",
      "type": "con",
      "side": "con",
      "depth": 0,
      "parent_id": "meta-con",
      "children_count": 1,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:23.823706"
    },
    {
      "id": "f9f9c760-c6c0-457c-9756-a03270648826",
      "text": "Late diagnosis of lethal fetal anomalies, such as bilateral renal agenesis or anencephaly, results in abortions performed primarily to end inevitable suffering for the fetus and the parents. Compassionate medical policies across Europe frequently recognize the ethical validity of avoiding prolonged gestation of a non-viable infant.",
      "type": "con",
      "side": "con",
      "depth": 0,
      "parent_id": "meta-con",
      "children_count": 1,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:23.824222"
    },
    {
      "id": "1d797704-a1e3-4715-8ebc-5bb63fceae81",
      "text": "Restrictions on late-term abortion are irrelevant for public health policy, as these procedures are extremely rare, typically constituting less than 1% of all abortions in jurisdictions like the United States. Focusing legislative attention on these rare medical emergencies diverts resources from improving access to earlier prenatal and abortion care.",
      "type": "con",
      "side": "con",
      "depth": 0,
      "parent_id": "meta-con",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:23.824498"
    },
    {
      "id": "c95ea1e7-8e7a-4e72-8a82-4e26ee961e25",
      "text": "In legal systems, such as Canada\u2019s, the absence of gestational limits places the decision entirely within the realm of medical professional judgment and the pregnant person's autonomy. When specialized medical necessity, not convenience, dictates a procedure, the act falls outside generalized considerations of immorality.",
      "type": "con",
      "side": "con",
      "depth": 0,
      "parent_id": "meta-con",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:23.824749"
    },
    {
      "id": "719f3a73-e76f-4ff4-a1e6-285ecc387d4e",
      "text": "The relevance of public health policy is not solely determined by frequency; legislation is necessary for rare but high-stakes medical situations, such as regulating complex organ donation protocols or specific infectious disease containment. The significant ethical and legal complexities of late-term procedures necessitate specific policies regardless of the less than 1% statistic.",
      "type": "objection",
      "side": "pro",
      "depth": 1,
      "parent_id": "1d797704-a1e3-4715-8ebc-5bb63fceae81",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:34.131963"
    },
    {
      "id": "b35d471f-a555-49a5-9388-4efc5bb20d4f",
      "text": "Regulation of rare, specific medical procedures utilizes prosecutorial and judicial resources, which do not compete for or divert funding allocated through established federal and state programs for early prenatal and preventative care.",
      "type": "objection",
      "side": "pro",
      "depth": 1,
      "parent_id": "1d797704-a1e3-4715-8ebc-5bb63fceae81",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:34.132403"
    },
    {
      "id": "1a6de7d4-1ed9-4cc7-bc70-e63aaf785f58",
      "text": "Late-term abortions are not \"almost exclusively\" performed for immediate mortal threats to the mother; data shows they are frequently performed following the diagnosis of severe fetal anomalies incompatible with life or due to broader, non-life-threatening maternal physical/mental health concerns.",
      "type": "objection",
      "side": "pro",
      "depth": 1,
      "parent_id": "5b781c00-07c4-4047-ba3a-d67479a83482",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:34.819007"
    },
    {
      "id": "184493f4-a326-4098-954c-2cdc7cfccabc",
      "text": "Late-term abortion for lethal fetal anomalies does not end fetal suffering, as these conditions often preclude conscious pain perception; the ethical justification is alleviating the parents\u2019 known and inevitable psychological suffering.",
      "type": "objection",
      "side": "pro",
      "depth": 1,
      "parent_id": "f9f9c760-c6c0-457c-9756-a03270648826",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:35.003413"
    },
    {
      "id": "1ddb0e9f-66cb-496f-9d50-ca62b991a162",
      "text": "Canada's legal system permits late-term abortions for reasons of socioeconomic distress or lifestyle preferences, significantly broadening the scope beyond procedures mandated solely by \"specialized medical necessity.\"",
      "type": "objection",
      "side": "pro",
      "depth": 1,
      "parent_id": "c95ea1e7-8e7a-4e72-8a82-4e26ee961e25",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:39.335271"
    },
    {
      "id": "03d43372-268d-421a-9d61-7dfac83668d6",
      "text": "Acts dictated by medical necessity, such as physician-assisted suicide or involuntary treatment, remain under intense generalized moral debate and are not automatically \"outside generalized considerations of immorality.\"",
      "type": "objection",
      "side": "pro",
      "depth": 1,
      "parent_id": "c95ea1e7-8e7a-4e72-8a82-4e26ee961e25",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:39.336116"
    },
    {
      "id": "2fe49f1e-b1cb-4ff7-8f75-ae222794f1df",
      "text": "Legislative attention, time for debate, and political capital are inherently limited resources; extensive governmental focus on one medical area demonstrably consumes this finite capacity, reducing the time available to prioritize other necessary healthcare improvements like maternal mortality or pediatric health.",
      "type": "response",
      "side": "con",
      "depth": 2,
      "parent_id": "b35d471f-a555-49a5-9388-4efc5bb20d4f",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:44.453078"
    },
    {
      "id": "d0716e33-bb6d-4399-b894-b0ab94ac22eb",
      "text": "While budget mechanisms may be separate on paper, all government spending ultimately draws from a single, finite pool of consolidated public revenue, meaning increased allocation toward one medical program politically and strategically limits the room for unrelated increases elsewhere.",
      "type": "response",
      "side": "con",
      "depth": 2,
      "parent_id": "b35d471f-a555-49a5-9388-4efc5bb20d4f",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:44.453921"
    },
    {
      "id": "ed63d124-069c-4f88-b925-d27d1394987c",
      "text": "In the US, less than 1.3% of abortions occur after 21 weeks of gestation; this low absolute volume means that procedures performed specifically for ambiguous non-lethal \"broader health concerns\" fall below any standard of being \"frequently performed.\"",
      "type": "response",
      "side": "con",
      "depth": 2,
      "parent_id": "1a6de7d4-1ed9-4cc7-bc70-e63aaf785f58",
      "children_count": 2,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:55.117112"
    },
    {
      "id": "1e901f34-a880-461b-95b5-c208646be51d",
      "text": "The medical necessity for procedures performed in the third trimester (post-28 weeks) is often different from those in the late second trimester (20-24 weeks); third-trimester procedures are typically classified as induced deliveries due to severe, immediate maternal or fetal conditions, not less-pressing non-life-threatening mental health issues.",
      "type": "response",
      "side": "con",
      "depth": 2,
      "parent_id": "1a6de7d4-1ed9-4cc7-bc70-e63aaf785f58",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:55.117539"
    },
    {
      "id": "a0d382c6-82a5-40fd-a140-5f581733b16e",
      "text": "Canadian medical practice guidelines, overseen by provincial colleges and hospitals, restrict access to late-term abortions (post-24 weeks) almost exclusively to cases involving severe fetal anomaly or significant risk to the woman's physical or mental health.",
      "type": "response",
      "side": "con",
      "depth": 2,
      "parent_id": "1ddb0e9f-66cb-496f-9d50-ca62b991a162",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:58.437745"
    },
    {
      "id": "520f9204-1f8c-4498-aa4b-77dd24754683",
      "text": "The 1988 Supreme Court decision, R. v. Morgentaler, established that \"health\" in the context of abortion includes psychological, emotional, and social well-being; thus, socioeconomic distress is encompassed within comprehensive health considerations, not separate from \"medical necessity.\"",
      "type": "response",
      "side": "con",
      "depth": 2,
      "parent_id": "1ddb0e9f-66cb-496f-9d50-ca62b991a162",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:10:58.438447"
    },
    {
      "id": "74819ec3-2996-4625-bb5b-dbad4d922885",
      "text": "Even 1.3% of US abortions represents over 10,000 procedures annually (based on 2020 CDC data), a volume far exceeding the threshold for \"frequent\" when considering specialized medical treatments for rare but severe maternal or fetal conditions.",
      "type": "response",
      "side": "pro",
      "depth": 3,
      "parent_id": "ed63d124-069c-4f88-b925-d27d1394987c",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:11:20.296656"
    },
    {
      "id": "3f970ac8-95ec-41ff-b285-7fbd928e546c",
      "text": "Late-term procedures classified under general \"health\" reasons often address concrete, life-altering conditions like severe maternal cardiac decompensation or newly diagnosed fetal anomalies such as lethal skeletal dysplasia, which are clearly defined medical emergencies, not \"ambiguous non-lethal\" concerns.",
      "type": "response",
      "side": "pro",
      "depth": 3,
      "parent_id": "ed63d124-069c-4f88-b925-d27d1394987c",
      "children_count": 0,
      "references": [],
      "source": "ai-generated",
      "created_at": "2025-10-11T00:11:20.296701"
    },
    {
      "id": "meta-pro",
      "text": "Arguments For",
      "type": "meta-pro",
      "side": "pro",
      "depth": -1,
      "parent_id": null,
      "children_count": 4,
      "references": [],
      "source": "system",
      "created_at": "2025-10-11T00:09:46.306677"
    },
    {
      "id": "meta-con",
      "text": "Arguments Against",
      "type": "meta-con",
      "side": "con",
      "depth": -1,
      "parent_id": null,
      "children_count": 4,
      "references": [],
      "source": "system",
      "created_at": "2025-10-11T00:09:46.306677"
    }
  ],
  "links": [
    {
      "source": "7e077846-360f-4289-8598-d5758b186122",
      "target": "07a31aa8-9646-4619-b05f-e5431380044b",
      "type": "objection"
    },
    {
      "source": "7e077846-360f-4289-8598-d5758b186122",
      "target": "8138b849-bdb6-4480-98eb-1104a7805da6",
      "type": "objection"
    },
    {
      "source": "3914c501-10a2-44a6-a6c9-355c64c5292c",
      "target": "7055f356-490f-4111-9ec7-9a5d86ff7fe9",
      "type": "objection"
    },
    {
      "source": "3914c501-10a2-44a6-a6c9-355c64c5292c",
      "target": "70a2aef6-6785-4f7f-8086-e8ff380e3f15",
      "type": "objection"
    },
    {
      "source": "d95056fc-6361-4d34-b861-1996dbaa26fe",
      "target": "fc74bbd9-5df5-4a44-ad16-2224937436df",
      "type": "objection"
    },
    {
      "source": "d95056fc-6361-4d34-b861-1996dbaa26fe",
      "target": "e93ba42c-c110-408f-9754-7c66765c6137",
      "type": "objection"
    },
    {
      "source": "d95056fc-6361-4d34-b861-1996dbaa26fe",
      "target": "dd4dff60-aef3-4ffe-b078-93a8a4650492",
      "type": "objection"
    },
    {
      "source": "fc74bbd9-5df5-4a44-ad16-2224937436df",
      "target": "45be1a59-180d-4a0a-9545-682c91b60ee4",
      "type": "response"
    },
    {
      "source": "e93ba42c-c110-408f-9754-7c66765c6137",
      "target": "41d5019d-b3a3-4c55-a627-41f9d58b89d5",
      "type": "response"
    },
    {
      "source": "e93ba42c-c110-408f-9754-7c66765c6137",
      "target": "b238740e-d331-4e5b-b04b-cd0636c9bdfe",
      "type": "response"
    },
    {
      "source": "1d797704-a1e3-4715-8ebc-5bb63fceae81",
      "target": "719f3a73-e76f-4ff4-a1e6-285ecc387d4e",
      "type": "objection"
    },
    {
      "source": "1d797704-a1e3-4715-8ebc-5bb63fceae81",
      "target": "b35d471f-a555-49a5-9388-4efc5bb20d4f",
      "type": "objection"
    },
    {
      "source": "5b781c00-07c4-4047-ba3a-d67479a83482",
      "target": "1a6de7d4-1ed9-4cc7-bc70-e63aaf785f58",
      "type": "objection"
    },
    {
      "source": "f9f9c760-c6c0-457c-9756-a03270648826",
      "target": "184493f4-a326-4098-954c-2cdc7cfccabc",
      "type": "objection"
    },
    {
      "source": "c95ea1e7-8e7a-4e72-8a82-4e26ee961e25",
      "target": "1ddb0e9f-66cb-496f-9d50-ca62b991a162",
      "type": "objection"
    },
    {
      "source": "c95ea1e7-8e7a-4e72-8a82-4e26ee961e25",
      "target": "03d43372-268d-421a-9d61-7dfac83668d6",
      "type": "objection"
    },
    {
      "source": "b35d471f-a555-49a5-9388-4efc5bb20d4f",
      "target": "2fe49f1e-b1cb-4ff7-8f75-ae222794f1df",
      "type": "response"
    },
    {
      "source": "b35d471f-a555-49a5-9388-4efc5bb20d4f",
      "target": "d0716e33-bb6d-4399-b894-b0ab94ac22eb",
      "type": "response"
    },
    {
      "source": "1a6de7d4-1ed9-4cc7-bc70-e63aaf785f58",
      "target": "ed63d124-069c-4f88-b925-d27d1394987c",
      "type": "response"
    },
    {
      "source": "1a6de7d4-1ed9-4cc7-bc70-e63aaf785f58",
      "target": "1e901f34-a880-461b-95b5-c208646be51d",
      "type": "response"
    },
    {
      "source": "1ddb0e9f-66cb-496f-9d50-ca62b991a162",
      "target": "a0d382c6-82a5-40fd-a140-5f581733b16e",
      "type": "response"
    },
    {
      "source": "1ddb0e9f-66cb-496f-9d50-ca62b991a162",
      "target": "520f9204-1f8c-4498-aa4b-77dd24754683",
      "type": "response"
    },
    {
      "source": "ed63d124-069c-4f88-b925-d27d1394987c",
      "target": "74819ec3-2996-4625-bb5b-dbad4d922885",
      "type": "response"
    },
    {
      "source": "ed63d124-069c-4f88-b925-d27d1394987c",
      "target": "3f970ac8-95ec-41ff-b285-7fbd928e546c",
      "type": "response"
    },
    {
      "source": "meta-pro",
      "target": "5eb0e98d-efc2-4c9a-892d-adb56324687e",
      "type": "meta-link"
    },
    {
      "source": "meta-pro",
      "target": "d95056fc-6361-4d34-b861-1996dbaa26fe",
      "type": "meta-link"
    },
    {
      "source": "meta-pro",
      "target": "7e077846-360f-4289-8598-d5758b186122",
      "type": "meta-link"
    },
    {
      "source": "meta-pro",
      "target": "3914c501-10a2-44a6-a6c9-355c64c5292c",
      "type": "meta-link"
    },
    {
      "source": "meta-con",
      "target": "5b781c00-07c4-4047-ba3a-d67479a83482",
      "type": "meta-link"
    },
    {
      "source": "meta-con",
      "target": "f9f9c760-c6c0-457c-9756-a03270648826",
      "type": "meta-link"
    },
    {
      "source": "meta-con",
      "target": "1d797704-a1e3-4715-8ebc-5bb63fceae81",
      "type": "meta-link"
    },
    {
      "source": "meta-con",
      "target": "c95ea1e7-8e7a-4e72-8a82-4e26ee961e25",
      "type": "meta-link"
    }
  ]
};

        // Dimensions
        const width = window.innerWidth;
        const height = window.innerHeight - 70;

        // ========== TEXT PROCESSING UTILITIES ==========

        /**
         * Extract first complete sentence(s) up to a character limit
         */
        function extractFirstSentences(text, maxChars) {
            // Match sentences (ending with . ! ? or .)
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [];

            if (sentences.length === 0) {
                return truncateAtWord(text, maxChars);
            }

            let result = '';
            for (const sentence of sentences) {
                if ((result + sentence).length <= maxChars) {
                    result += sentence;
                } else {
                    break;
                }
            }

            // If we got at least one sentence, return it
            if (result.length > 0) {
                return result.trim();
            }

            // Otherwise, truncate the first sentence at word boundary
            return truncateAtWord(sentences[0], maxChars);
        }

        /**
         * Truncate text at word boundary
         */
        function truncateAtWord(text, maxChars) {
            if (text.length <= maxChars) {
                return text;
            }

            // Find last space before maxChars
            let truncated = text.substring(0, maxChars);
            const lastSpace = truncated.lastIndexOf(' ');

            if (lastSpace > maxChars * 0.6) {
                truncated = truncated.substring(0, lastSpace);
            }

            return truncated.trim() + '...';
        }

        /**
         * Get display text for node based on depth
         */
        function getNodeDisplayText(d) {
            // Meta nodes show full text
            if (d.type === 'meta-pro' || d.type === 'meta-con') {
                return d.text;
            }

            // Character limits based on depth
            const limits = {
                0: 120,  // Root nodes - show more
                1: 90,
                2: 70,
                3: 50,
                4: 35,
                5: 30
            };

            const maxChars = limits[Math.min(d.depth, 5)];
            return extractFirstSentences(d.text, maxChars);
        }

        /**
         * Get tooltip text (2-3 sentences)
         */
        function getTooltipText(d) {
            const preview = extractFirstSentences(d.text, 300);
            return `[${d.type.toUpperCase()}] ${preview}`;
        }

        /**
         * Calculate node radius based on importance and text length
         */
        function getNodeRadius(d) {
            // Meta nodes are MUCH larger to be prominent cluster centers
            if (d.type === 'meta-pro' || d.type === 'meta-con') {
                return 120;
            }

            // Base radius by depth
            const baseRadius = {
                0: 45,  // Root nodes largest
                1: 35,
                2: 30,
                3: 25,
                4: 22,
                5: 20
            };

            const base = baseRadius[Math.min(d.depth, 5)] || 20;

            // Adjust slightly based on text length
            const textFactor = Math.sqrt(d.text.length) * 0.3;

            return base + textFactor;
        }

        /**
         * Get foreignObject dimensions for text wrapping
         */
        function getForeignObjectSize(d) {
            // Meta nodes get much larger text areas
            if (d.type === 'meta-pro' || d.type === 'meta-con') {
                return {
                    width: 320,
                    height: 120
                };
            }

            const widths = {
                0: 200,
                1: 170,
                2: 150,
                3: 120,
                4: 100,
                5: 85
            };

            const heights = {
                0: 70,
                1: 60,
                2: 55,
                3: 50,
                4: 45,
                5: 40
            };

            return {
                width: widths[Math.min(d.depth, 5)] || 85,
                height: heights[Math.min(d.depth, 5)] || 40
            };
        }

        // Create SVG
        const svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height);

        // Create zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Main group for zoom/pan
        const g = svg.append("g");

        // Define unified arrow markers with clean neutral styling
        const defs = svg.append("defs");

        // Unified neutral arrow for all link types
        const arrowTypes = ['pro', 'con', 'objection', 'response', 'default', 'meta-link'];

        arrowTypes.forEach(type => {
            defs.append("marker")
                .attr("id", `arrow-${type}`)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 10) // Position arrow tip at the edge
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-3L10,0L0,3")
                .attr("fill", "#6c757d")
                .attr("opacity", 0.5);
        });

        // Create force simulation with improved parameters to prevent overlap
        const simulation = d3.forceSimulation(graphData.nodes)
            .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(d => {
                // Much longer links for better spacing
                const target = d.target;
                const depth = typeof target === 'object' ? target.depth : 0;
                const sourceRadius = getNodeRadius(d.source);
                const targetRadius = getNodeRadius(target);
                // Significantly increased spacing between nodes
                return Math.max(250, sourceRadius + targetRadius + 150 + (depth * 40));
            }).strength(0.4)) // Reduced from 0.6 to make links more flexible
            .force("charge", d3.forceManyBody()
                .strength(d => {
                    // Strong repulsion to prevent overlap
                    const radius = getNodeRadius(d);
                    return -1500 - (radius * 20); // Increased repulsion
                })
                .distanceMax(1000)) // Increased distance
            .force("center", d3.forceCenter(width / 2, height / 2).strength(0.01))
            .force("x", d3.forceX(width / 2).strength(0.005))
            // Gentler Y-force for softer layering
            .force("y", d3.forceY(d => {
                // Position nodes in horizontal layers based on depth with larger spacing
                const layerHeight = 280;
                const startY = height / 2 - 200;
                return startY + (d.depth + 1) * layerHeight;
            }).strength(0.25)) // Reduced from 0.6 for more flexibility
            .force("collision", d3.forceCollide()
                .radius(d => getNodeRadius(d) + 60) // Increased from 40
                .strength(1.0)
                .iterations(4))
            .alphaDecay(0.015)
            .velocityDecay(0.4);

        // Find meta nodes
        const metaProNode = graphData.nodes.find(n => n.type === 'meta-pro');
        const metaConNode = graphData.nodes.find(n => n.type === 'meta-con');

        // Add custom force to separate meta nodes horizontally and cluster children around them
        if (metaProNode && metaConNode) {
            simulation.force("cluster", function(alpha) {
                const separation = 1400; // Distance between meta nodes

                graphData.nodes.forEach(d => {
                    if (d.type === 'meta-pro') {
                        // Push meta-pro to the left
                        d.vx -= (d.x - (width / 2 - separation / 2)) * 0.15 * alpha;
                    } else if (d.type === 'meta-con') {
                        // Push meta-con to the right
                        d.vx += ((width / 2 + separation / 2) - d.x) * 0.15 * alpha;
                    } else {
                        // Gentle horizontal clustering only (no vertical pull)
                        let targetX;

                        if (d.side === 'pro') {
                            // Pro nodes gently attracted to left cluster
                            targetX = metaProNode.x || (width / 2 - separation / 2);
                        } else {
                            // Con nodes gently attracted to right cluster
                            targetX = metaConNode.x || (width / 2 + separation / 2);
                        }

                        // Very gentle horizontal pull only (removed vertical)
                        const dx = targetX - d.x;
                        d.vx += dx * 0.01 * alpha; // Reduced from 0.04
                    }
                });
            });
        }

        // Create links with arrows using curved paths
        const link = g.append("g")
            .selectAll("path")
            .data(graphData.links)
            .enter().append("path")
            .attr("class", d => `link ${d.type}`)
            .attr("stroke-width", d => {
                const target = d.target;
                const depth = typeof target === 'object' ? target.depth : 0;
                return Math.max(1, 4 - depth);
            })
            .attr("marker-end", d => `url(#arrow-${d.type})`)
            .attr("fill", "none");

        // Create nodes
        const node = g.append("g")
            .selectAll("g")
            .data(graphData.nodes)
            .enter().append("g")
            .attr("class", d => `node ${d.type} ${d.side} depth-${d.depth}`)
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        // Add circles to nodes (invisible, only for physics)
        node.append("circle")
            .attr("r", d => getNodeRadius(d));

        // Add multi-line labels using foreignObject for better text wrapping
        node.each(function(d) {
            const nodeGroup = d3.select(this);
            const size = getForeignObjectSize(d);
            const displayText = getNodeDisplayText(d);

            // Create foreignObject for HTML text wrapping
            const fo = nodeGroup.append("foreignObject")
                .attr("x", -size.width / 2)
                .attr("y", -size.height / 2)
                .attr("width", size.width)
                .attr("height", size.height)
                .on("click", function(event) {
                    event.stopPropagation();
                    showNodeDetails(d);
                })
                .on("dblclick", function(event) {
                    event.stopPropagation();
                    toggleSubtree(d);
                });

            // Create HTML content with just text (no badges for cleaner look)
            const div = fo.append("xhtml:div")
                .attr("class", "node-label")
                .style("width", "100%")
                .style("height", "100%")
                .style("display", "flex")
                .style("flex-direction", "column")
                .style("align-items", "center")
                .style("justify-content", "center")
                .attr("title", getTooltipText(d));

            // Add text content only (badges removed for cleaner appearance)
            div.append("xhtml:div")
                .attr("class", "node-text-content")
                .style("font-size", d.type === 'meta-pro' || d.type === 'meta-con' ? "17px" : (d.depth === 0 ? "14px" : (d.depth <= 2 ? "12px" : "11px")))
                .style("font-weight", d.type === 'meta-pro' || d.type === 'meta-con' ? "700" : (d.depth === 0 ? "600" : "500"))
                .text(displayText);
        });

        // Helper function to get text box edge point with small gap for arrow
        function getBoxEdgePoint(node, fromX, fromY) {
            const size = getForeignObjectSize(node);
            const halfW = size.width / 2;
            const halfH = size.height / 2;

            // Calculate angle from source to target
            const dx = node.x - fromX;
            const dy = node.y - fromY;
            const angle = Math.atan2(dy, dx);

            // Calculate intersection with rectangle
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);

            // Small gap for arrow (in pixels)
            const gap = 8;

            // Check which edge we hit first
            let x, y;
            if (Math.abs(cos) > Math.abs(sin) * (halfW / halfH)) {
                // Hit left or right edge
                x = node.x - Math.sign(cos) * (halfW + gap);
                y = node.y - Math.tan(angle) * Math.sign(cos) * (halfW + gap);
            } else {
                // Hit top or bottom edge
                y = node.y - Math.sign(sin) * (halfH + gap);
                x = node.x - (y - node.y) / Math.tan(angle);
            }

            return { x, y };
        }

        // Update positions on simulation tick
        simulation.on("tick", () => {
            link.each(function(d) {
                const source = d.source;
                const target = d.target;

                // Get edge points of text boxes
                const sourcePoint = getBoxEdgePoint(source, target.x, target.y);
                const targetPoint = getBoxEdgePoint(target, source.x, source.y);

                // Create straight path
                const pathData = `M ${sourcePoint.x},${sourcePoint.y} L ${targetPoint.x},${targetPoint.y}`;

                d3.select(this).attr("d", pathData);
            });

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Search functionality
        document.getElementById("search").addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase();

            node.classed("highlighted", false);

            if (query) {
                node.classed("highlighted", d =>
                    d.text.toLowerCase().includes(query)
                );
            }
        });

        // ========== SIDEBAR UTILITIES ==========

        /**
         * Get path from root to node (for breadcrumb)
         */
        function getNodePath(nodeId) {
            const path = [];
            let current = graphData.nodes.find(n => n.id === nodeId);

            while (current) {
                path.unshift(current);
                if (current.parent_id) {
                    current = graphData.nodes.find(n => n.id === current.parent_id);
                } else {
                    break;
                }
            }

            return path;
        }

        /**
         * Get all children of a node
         */
        function getChildren(nodeId) {
            return graphData.nodes.filter(n => n.parent_id === nodeId);
        }

        /**
         * Count all descendants recursively
         */
        function countDescendants(nodeId) {
            const children = getChildren(nodeId);
            let count = children.length;

            children.forEach(child => {
                count += countDescendants(child.id);
            });

            return count;
        }

        /**
         * Focus camera on a specific node
         */
        function focusOnNode(nodeId) {
            const nodeData = graphData.nodes.find(n => n.id === nodeId);
            if (!nodeData) return;

            const scale = 1.5;
            const translateX = width / 2 - scale * nodeData.x;
            const translateY = height / 2 - scale * nodeData.y;

            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(translateX, translateY).scale(scale)
            );
        }

        /**
         * Copy text to clipboard
         */
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show brief confirmation
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // Show node details in sidebar
        function showNodeDetails(d) {
            node.classed("selected", false);
            d3.select(event.target.parentNode).classed("selected", true);

            const sidebar = document.getElementById("sidebar");
            const sidebarHeader = document.getElementById("sidebar-header");
            const sidebarBody = document.getElementById("sidebar-body");

            // Build breadcrumb
            const path = getNodePath(d.id);
            let breadcrumbHtml = '<div class="breadcrumb">';
            path.forEach((node, index) => {
                if (index > 0) {
                    breadcrumbHtml += '<span class="breadcrumb-separator">‚Ä∫</span>';
                }
                const truncated = truncateAtWord(node.text, 30);
                breadcrumbHtml += `<span class="breadcrumb-item" onclick="showNodeDetails(graphData.nodes.find(n => n.id === '${node.id}'))">${truncated}</span>`;
            });
            breadcrumbHtml += '</div>';

            // Header with breadcrumb
            sidebarHeader.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span class="node-badge-large ${d.type}">${d.type}</span>
                    <span class="node-badge-large ${d.side}">${d.side}</span>
                </div>
                <h2>Argument Details</h2>
                ${breadcrumbHtml}
            `;

            // Get children and descendants
            const children = getChildren(d.id);
            const descendantCount = countDescendants(d.id);

            // Build body content
            let bodyHtml = `
                <!-- Main Argument Section -->
                <div class="section">
                    <div class="section-title">üìù Argument</div>
                    <div class="node-text">${d.text}</div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="focusOnNode('${d.id}')">
                        üéØ Focus
                    </button>
                    <button class="action-btn" onclick="copyToClipboard(\`${d.text.replace(/`/g, '\\`')}\`)">
                        üìã Copy
                    </button>
                </div>

                <!-- Statistics -->
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-box-value">${d.depth}</div>
                        <div class="stat-box-label">Depth</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${children.length}</div>
                        <div class="stat-box-label">Children</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${descendantCount}</div>
                        <div class="stat-box-label">Descendants</div>
                    </div>
                </div>

                <!-- Metadata Grid -->
                <div class="section">
                    <div class="section-title">‚ÑπÔ∏è Metadata</div>
                    <div class="meta-grid">
                        <div class="meta-item">
                            <div class="meta-label">Source</div>
                            <div class="meta-value">${d.source}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Created</div>
                            <div class="meta-value">${new Date(d.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            `;

            // Add children section
            if (children.length > 0) {
                // Determine label based on node type
                let childrenLabel;
                if (d.type === 'meta-pro') {
                    childrenLabel = `${children.length} Supporting ${children.length === 1 ? 'Argument' : 'Arguments'}`;
                } else if (d.type === 'meta-con') {
                    childrenLabel = `${children.length} Opposing ${children.length === 1 ? 'Argument' : 'Arguments'}`;
                } else {
                    childrenLabel = `${children.length} ${children.length === 1 ? 'Response' : 'Responses'}`;
                }

                bodyHtml += `
                    <div class="section">
                        <div class="section-title">üå≥ ${childrenLabel}</div>
                `;

                children.forEach(child => {
                    const preview = truncateAtWord(child.text, 150);
                    bodyHtml += `
                        <div class="child-node ${child.type}" onclick="showNodeDetails(graphData.nodes.find(n => n.id === '${child.id}'))">
                            <div class="child-node-header">
                                <span class="child-node-badge ${child.type}" style="
                                    background: ${child.type === 'pro' ? '#d5f0e8' : child.type === 'con' ? '#f7e0e0' : child.type === 'objection' ? '#ffecd9' : '#e3eef8'};
                                    color: ${child.type === 'pro' ? '#2d9e7e' : child.type === 'con' ? '#c74848' : child.type === 'objection' ? '#d97a30' : '#4a7fb8'};
                                ">${child.type}</span>
                                <span style="font-size: 0.75em; color: #72777d;">${child.children_count} ${child.children_count === 1 ? 'reply' : 'replies'}</span>
                            </div>
                            <div class="child-node-text">${preview}</div>
                        </div>
                    `;
                });

                bodyHtml += '</div>';
            } else {
                bodyHtml += `
                    <div class="section">
                        <div class="empty-state">
                            <div style="font-size: 2em; margin-bottom: 10px;">üí≠</div>
                            <div>No responses yet</div>
                            <div style="font-size: 0.85em; margin-top: 5px;">This is a leaf node in the argument tree</div>
                        </div>
                    </div>
                `;
            }

            // Add references section
            if (d.references && d.references.length > 0) {
                bodyHtml += `
                    <div class="section">
                        <div class="section-title">üîó References</div>
                        <ul class="references-list">
                `;

                d.references.forEach(ref => {
                    bodyHtml += `<li><a href="${ref}" target="_blank">${ref}</a></li>`;
                });

                bodyHtml += `
                        </ul>
                    </div>
                `;
            }

            sidebarBody.innerHTML = bodyHtml;
            sidebar.classList.add("open");
        }

        function closeSidebar() {
            document.getElementById("sidebar").classList.remove("open");
            node.classed("selected", false);
        }

        // Click outside to close sidebar
        svg.on("click", () => {
            closeSidebar();
        });

        // Button handlers - Reset and fit view
        function resetAndFit() {
            // Clear search and highlights
            document.getElementById("search").value = "";
            node.classed("highlighted", false);
            closeSidebar();

            // Fit graph to view with animation
            const bounds = g.node().getBBox();
            const fullWidth = width;
            const fullHeight = height;
            const widthScale = fullWidth / bounds.width;
            const heightScale = fullHeight / bounds.height;
            const scale = Math.min(widthScale, heightScale) * 0.85;
            const translateX = fullWidth / 2 - scale * (bounds.x + bounds.width / 2);
            const translateY = fullHeight / 2 - scale * (bounds.y + bounds.height / 2);

            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(translateX, translateY).scale(scale)
            );
        }

        function toggleSubtree(d) {
            // TODO: Implement toggle subtree
            console.log("Toggle subtree not yet implemented for", d.id);
        }

        // Handle window resize
        window.addEventListener("resize", () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight - 70;
            svg.attr("width", newWidth).attr("height", newHeight);
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulation.alpha(0.3).restart();
        });
    </script>
</body>
</html>